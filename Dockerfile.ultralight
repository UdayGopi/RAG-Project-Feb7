# =============================================================================
# ALTERNATIVE: Dockerfile.ultralight (small image, API-only)
# =============================================================================
# Build:  docker build -f Dockerfile.ultralight -t carepolicy-hub:latest .
# Uses:   requirements.ultralight.txt (no .env copied; set env at runtime)
# Image:  <300MB. Requires OPENAI_API_KEY (or Cohere) for embeddings; no rag_agent.py in image (see note below).
# Default Dockerfile (recommended): use root Dockerfile for full app.
# =============================================================================
# Target: < 300MB final image
# Strategy: Alpine base + API-based ML (no local models)

# ============================================
# Stage 1: Builder
# ============================================
FROM python:3.11-alpine AS builder

WORKDIR /build

# Install build dependencies (minimal)
RUN apk add --no-cache \
    gcc \
    musl-dev \
    libffi-dev \
    openssl-dev

# Copy requirements
COPY requirements.ultralight.txt .

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install dependencies with no cache
RUN pip install --no-cache-dir --upgrade pip wheel && \
    pip install --no-cache-dir -r requirements.ultralight.txt

# ============================================
# Stage 2: Runtime (Ultra-lightweight)
# ============================================
FROM python:3.11-alpine

LABEL maintainer="your-email@example.com"
LABEL description="RAG Application - Ultra-lightweight"
LABEL version="2.0.0"
LABEL size="<300MB"

# Environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH="/opt/venv/bin:$PATH" \
    APP_HOME=/app

# Install only essential runtime dependencies
RUN apk add --no-cache \
    curl \
    ca-certificates \
    libffi \
    openssl

# Create non-root user
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR $APP_HOME

# Copy Python packages from builder
COPY --from=builder /opt/venv /opt/venv

# Copy application code (order optimized for caching)
COPY --chown=appuser:appuser config/ ./config/
COPY --chown=appuser:appuser core/ ./core/
COPY --chown=appuser:appuser agents/ ./agents/
COPY --chown=appuser:appuser storage/ ./storage/
COPY --chown=appuser:appuser models/ ./models/
COPY --chown=appuser:appuser retrieval/ ./retrieval/
COPY --chown=appuser:appuser database/ ./database/
COPY --chown=appuser:appuser api/ ./api/
COPY --chown=appuser:appuser utils/ ./utils/
COPY --chown=appuser:appuser ingestion/ ./ingestion/
COPY --chown=appuser:appuser static/ ./static/
COPY --chown=appuser:appuser app.py .

# Create directories
RUN mkdir -p logs data/cache && \
    chown -R appuser:appuser logs data

# Switch to non-root user
USER appuser

# Expose port
EXPOSE 5001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:5001/health || exit 1

# Use gunicorn with minimal workers for small footprint
CMD ["gunicorn", \
    "--bind", "0.0.0.0:5001", \
    "--workers", "1", \
    "--threads", "2", \
    "--worker-class", "gthread", \
    "--timeout", "300", \
    "--access-logfile", "-", \
    "--error-logfile", "-", \
    "--log-level", "info", \
    "--max-requests", "1000", \
    "--max-requests-jitter", "100", \
    "app:app"]
