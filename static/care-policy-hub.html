<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarePolicy Hub - AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #f8fafc;
            overflow: hidden;
            height: 100dvh;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'IBM Plex Sans', 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Animations */
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slide-in-fade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
        
        .message-in {
            animation: slide-in-fade 0.5s ease-out forwards;
        }
        
        /* Typing Indicator */
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        /* Markdown Prose Styles */
        .prose {
            max-width: none;
        }
        
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        
        .prose ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
        }
        
        .prose pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        
        .prose code {
            background: #f1f5f9;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        
        /* Tab Active State */
        .tab-active {
            color: #2563eb !important;
            font-weight: 600 !important;
            border-bottom: 2px solid #2563eb !important;
        }
    </style>
</head>
<body class="w-full h-screen p-4 flex justify-center items-center">
    <main id="app-page" class="w-full h-full max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-4 fade-in" style="height:100dvh;">
        <!-- Sidebar -->
        <aside id="sidebar" class="md:col-span-1 h-full rounded-2xl p-4 flex flex-col bg-white border border-slate-200 shadow-lg overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-900 tracking-tight">CarePolicy Hub</h1>
                        <p class="text-xs text-slate-500 font-medium">AI Policy Assistant</p>
                    </div>
                </div>
                <button id="close-sidebar" class="md:hidden p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50" aria-label="Close sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="flex-grow flex flex-col overflow-y-auto">
                <h2 class="text-sm font-semibold text-slate-700 mb-3">Chat History</h2>
                <div class="mb-4 p-3 bg-slate-50 rounded-xl border border-slate-200">
                    <label class="text-xs text-slate-600 font-medium">Filter by date:</label>
                    <div class="flex gap-2 mt-2">
                        <input type="date" id="start-date-filter" class="flex-1 p-2 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="date" id="end-date-filter" class="flex-1 p-2 text-xs border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div id="chat-history-list" class="flex-grow space-y-2 overflow-y-auto pr-2"></div>
            </div>
            
            <button id="new-conversation-btn" class="mt-4 w-full bg-blue-600 text-white p-3 rounded-xl text-sm font-semibold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"/>
                    <path d="M12 5v14"/>
                </svg>
                New Conversation
            </button>
        </aside>

        <!-- Main Content Area -->
        <section class="md:col-span-3 h-full rounded-2xl flex flex-col overflow-hidden bg-white border border-slate-200 shadow-lg">
            <!-- Header with Tabs -->
            <div class="flex justify-between items-center px-6 py-4 border-b border-slate-200 flex-shrink-0">
                <div id="tabs" class="flex gap-1 overflow-x-auto">
                    <button data-target="chat-panel" class="tab-btn tab-active text-blue-600 font-semibold text-sm pb-3 px-4 flex-shrink-0 border-b-2 border-blue-600 transition-all">Chat</button>
                    <button data-target="upload-panel" class="tab-btn text-slate-500 hover:text-blue-600 font-medium text-sm pb-3 px-4 flex-shrink-0 transition-all">Upload Docs</button>
                    <button data-target="analytics-panel" class="tab-btn text-slate-500 hover:text-blue-600 font-medium text-sm pb-3 px-4 flex-shrink-0 transition-all">Analytics</button>
                    <button data-target="scheduler-panel" class="tab-btn text-slate-500 hover:text-blue-600 font-medium text-sm pb-3 px-4 flex-shrink-0 transition-all">Scheduler</button>
                </div>
                <button id="signout-btn" class="text-xs px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50 font-medium transition-all">
                    Sign Out
                </button>
            </div>
            
            <!-- Panels Content -->
            <div id="panels" class="flex-1 overflow-y-auto min-h-0">
                <!-- Chat Panel -->
                <div id="chat-panel" class="panel-content h-full flex flex-col min-h-0">
                    <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 min-h-0 bg-slate-50"></div>
                    <div class="mt-auto pt-4 px-6 pb-6 flex-shrink-0 bg-white border-t border-slate-200">
                        <form id="chat-form" class="relative">
                            <textarea 
                                id="chat-input" 
                                rows="1" 
                                placeholder="Ask a question about your policies..." 
                                class="w-full bg-white border border-slate-300 rounded-xl p-4 pr-16 text-sm text-slate-900 placeholder-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none transition-all"
                            ></textarea>
                            <button 
                                type="submit" 
                                class="absolute right-3 top-1/2 -translate-y-1/2 px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-slate-400 shadow-md text-white font-semibold text-sm"
                            >
                                Send
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Upload Panel -->
                <div id="upload-panel" class="panel-content hidden p-6 space-y-6 h-full overflow-y-auto bg-slate-50">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-xl font-bold text-slate-900 mb-4 tracking-tight">Ingest New Documents</h3>
                            <form id="upload-form" class="space-y-4">
                                <div>
                                    <label for="tenant-select" class="block text-sm font-semibold text-slate-700 mb-2">Select Existing Tenant</label>
                                    <select id="tenant-select" name="tenant_id" class="w-full p-3 border border-slate-300 rounded-lg bg-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
                                </div>
                                
                                <div class="text-center py-2">
                                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Or</span>
                                </div>
                                
                                <div>
                                    <label for="new-tenant-input" class="block text-sm font-semibold text-slate-700 mb-2">Create New Tenant</label>
                                    <input type="text" id="new-tenant-input" name="new_tenant_id" placeholder="Enter new tenant name..." class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <hr class="border-slate-200">
                                
                                <div>
                                    <label for="url-input" class="block text-sm font-semibold text-slate-700 mb-2">Ingest from URL</label>
                                    <input type="url" id="url-input" name="url" placeholder="https://example.com/policy" class="w-full p-3 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Upload Files</label>
                                    <div id="drop-zone" class="mt-2 flex justify-center items-center flex-col w-full h-32 px-6 transition bg-white border-2 border-slate-300 border-dashed rounded-xl cursor-pointer hover:border-blue-400 hover:bg-blue-50">
                                        <input type="file" id="file-input" name="files" multiple class="hidden"/>
                                        <label for="file-input" class="text-center cursor-pointer">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 mb-2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                                <polyline points="17 8 12 3 7 8"/>
                                                <line x1="12" y1="3" x2="12" y2="15"/>
                                            </svg>
                                            <span class="font-semibold text-slate-700 text-sm block mb-1">Drag & drop or click to select</span>
                                            <span class="text-xs text-slate-500">PDF, TXT, DOCX supported</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="file-list" class="text-xs"></div>
                                
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-xl hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
                                    Upload & Ingest
                                </button>
                            </form>
                            <div id="upload-summary" class="mt-4 hidden text-sm bg-slate-50 border border-slate-200 rounded-xl p-4"></div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl border border-blue-200 p-6 shadow-sm">
                            <h4 class="font-bold text-slate-900 text-lg mb-4 tracking-tight">How to Ingest Content</h4>
                            <ul class="space-y-4 text-sm text-slate-600">
                                <li class="flex gap-3">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">1</div>
                                    <div>
                                        <strong class="text-slate-900">Choose Tenant:</strong> Select an existing project/topic or create a new one to keep documents organized.
                                    </div>
                                </li>
                                <li class="flex gap-3">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">2</div>
                                    <div>
                                        <strong class="text-slate-900">Add Content:</strong> Paste a URL to ingest a webpage or upload one or more document files.
                                    </div>
                                </li>
                                <li class="flex gap-3">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">3</div>
                                    <div>
                                        <strong class="text-slate-900">Start Ingestion:</strong> Click "Upload & Ingest" to process and add content to the knowledge base.
                                    </div>
                                </li>
                                <li class="flex gap-3">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs font-bold">4</div>
                                    <div>
                                        <strong class="text-slate-900">Start Chatting:</strong> Navigate to the Chat tab to ask questions about the newly added information.
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Panel -->
                <div id="analytics-panel" class="panel-content hidden p-6 h-full overflow-y-auto bg-slate-50">
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-2xl font-bold text-slate-900 mb-6 tracking-tight">Query Analytics</h3>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h4 class="text-lg font-semibold text-slate-800 mb-4">Queries per Tenant</h4>
                            <div class="mt-4" style="height: 300px;">
                                <canvas id="tenant-chart"></canvas>
                            </div>
                        </div>
                        <ul id="tenant-list" class="mt-6 text-sm text-slate-700 space-y-2"></ul>
                    </div>
                </div>
                
                <!-- Scheduler Panel -->
                <div id="scheduler-panel" class="panel-content hidden p-6 space-y-6 h-full overflow-y-auto bg-slate-50">
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-2xl font-bold text-slate-900 mb-6 tracking-tight">Scheduler Ingestion</h3>
                        <form id="schedule-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Select Tenant</label>
                                <select id="sch-tenant-select" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
                                <p class="text-xs text-slate-500 mt-1.5">or create a new tenant</p>
                                <input id="sch-tenant-new" type="text" class="mt-2 w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="New tenant ID (optional)">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">URL</label>
                                <input id="sch-url" type="url" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="https://...">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Frequency</label>
                                <select id="sch-frequency" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="hourly">Hourly</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="3months">Every 3 months</option>
                                    <option value="6months">Every 6 months</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Start time (ISO)</label>
                                <input id="sch-start" type="datetime-local" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-xl hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
                                    Add Schedule
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                        <h4 class="text-lg font-bold text-slate-900 mb-4 tracking-tight">Existing Schedules</h4>
                        <ul id="schedules-list" class="space-y-2 text-sm text-slate-700"></ul>
                        <p id="schedules-empty" class="mt-3 text-sm text-slate-500 hidden">No schedules yet.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('CarePolicy Hub: DOMContentLoaded initialized');
            const API_BASE_URL = window.location.origin;
            try { marked.setOptions({ gfm: true, breaks: true }); } catch {}

            // --- Element Selectors ---
            const chatWindow = document.getElementById('chat-window');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatHistoryList = document.getElementById('chat-history-list');
            const startDateFilter = document.getElementById('start-date-filter');
            const endDateFilter = document.getElementById('end-date-filter');
            const uploadForm = document.getElementById('upload-form');
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('drop-zone');
            const fileList = document.getElementById('file-list');
            const uploadSummary = document.getElementById('upload-summary');
            const newConversationBtn = document.getElementById('new-conversation-btn');
            const tenantSelect = document.getElementById('tenant-select');
            const sidebar = document.getElementById('sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            let tenantChart = null;

            // --- Tabs: simple controller ---
            const panelsRoot = document.getElementById('panels');
            const tabButtons = Array.from(document.querySelectorAll('#tabs .tab-btn'));
            
            function activateTab(targetId) {
                if (!panelsRoot) return;
                const panels = Array.from(panelsRoot.querySelectorAll('.panel-content'));
                panels.forEach(p => p.classList.add('hidden'));
                const targetEl = document.getElementById(targetId);
                if (targetEl) targetEl.classList.remove('hidden');
                
                // Update tab styles
                tabButtons.forEach(btn => {
                    if (btn.dataset.target === targetId) {
                        btn.classList.add('tab-active', 'text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-600');
                        btn.classList.remove('text-slate-500', 'font-medium');
                    } else {
                        btn.classList.remove('tab-active', 'text-blue-600', 'font-semibold', 'border-b-2', 'border-blue-600');
                        btn.classList.add('text-slate-500', 'font-medium');
                    }
                });
                
                // Load data for specific tabs
                try {
                    if (targetId === 'upload-panel') {
                        if (typeof fetchTenants === 'function') fetchTenants();
                    } else if (targetId === 'analytics-panel') {
                        if (typeof loadAnalytics === 'function') loadAnalytics();
                    } else if (targetId === 'scheduler-panel') {
                        if (typeof fetchTenants === 'function') fetchTenants();
                        if (typeof loadSchedules === 'function') loadSchedules();
                    }
                } catch {}
            }
            
            // Bind tab clicks
            tabButtons.forEach(btn => btn.addEventListener('click', () => {
                const target = btn.dataset.target;
                activateTab(target);
                const hash = target === 'chat-panel' ? '#chat' : (target === 'upload-panel' ? '#upload' : (target === 'analytics-panel' ? '#analytics' : (target === 'scheduler-panel' ? '#scheduler' : '')));
                if (hash) location.hash = hash;
            }));

            // Handle initial hash
            (function handleInitialHash() {
                switch ((location.hash || '').toLowerCase()) {
                    case '#upload':
                        activateTab('upload-panel');
                        break;
                    case '#analytics':
                        activateTab('analytics-panel');
                        break;
                    case '#scheduler':
                        activateTab('scheduler-panel');
                        break;
                    case '#chat':
                    default:
                        activateTab('chat-panel');
                        break;
                }
            })();
            
            // --- Notification (disabled by default) ---
            const ENABLE_TOASTS = false;
            function showNotification(message, isError = false) {
                if (!ENABLE_TOASTS) return;
                const el = document.createElement('div');
                el.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'} transition-all duration-300 opacity-0 transform translate-y-2 z-50`;
                el.textContent = message;
                document.body.appendChild(el);
                setTimeout(() => el.classList.remove('opacity-0', 'translate-y-2'), 10);
                setTimeout(() => { el.classList.add('opacity-0', 'translate-y-2'); setTimeout(() => el.remove(), 5000); }, 5000);
            }

            function notifyOnboarding(data) {
                try {
                    if (!data || !data.is_download_intent) return;
                    const el = document.createElement('div');
                    el.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white bg-blue-600 transition-all duration-300 opacity-0 transform translate-y-2 z-50';
                    el.textContent = 'Onboarding detected. You can use the Download button in Sources.';
                    document.body.appendChild(el);
                    setTimeout(() => el.classList.remove('opacity-0','translate-y-2'), 10);
                    setTimeout(() => { el.classList.add('opacity-0','translate-y-2'); setTimeout(() => el.remove(), 5000); }, 5000);
                } catch {}
            }
            
            // --- Chat UI Functions ---
            function displayWelcomeMessage() {
                chatWindow.innerHTML = '';
                const welcomeData = {
                    is_welcome: true,
                    detailed_response: "üëã Hi, I'm your policy bot ü§ñ\n\nUse the 'Upload Docs' tab to add knowledge, then ask me anything about it.",
                };
                appendMessage(welcomeData, 'ai', "Welcome");
            }

            async function ensureAuth() {
                try {
                    const res = await fetch(`${API_BASE_URL}/me`, { credentials: 'include' });
                    if (res.status === 401) { window.location.href = '/auth.html'; return null; }
                    const me = await res.json();
                    return me;
                } catch (e) { window.location.href = '/auth.html'; return null; }
            }

            let isSending = false;
            async function submitQuery(query) {
                if (!query) return;
                const me = await ensureAuth(); if (!me) return;
                if (isSending) return;
                isSending = true;
                
                appendMessage(query, 'user');
                chatInput.value = '';
                showThinkingIndicator();
                const sendBtn = document.querySelector('#chat-form button[type="submit"]');
                if (sendBtn) sendBtn.disabled = true;

                try {
                    const res = await fetch(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ query: query }),
                    });
                    
                    removeThinkingIndicator();
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || `Server error: ${res.status}`);
                    
                    appendMessage(result, 'ai', query);
                    notifyOnboarding(result);
                    loadChatHistory();
                } catch (error) {
                    removeThinkingIndicator();
                    appendMessage({ summary: "Error", detailed_response: error.message }, 'ai-error', query);
                } finally {
                    isSending = false;
                    if (sendBtn) sendBtn.disabled = false;
                }
            }
            
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                submitQuery(chatInput.value.trim());
            });

            // Auto-resize textarea
            function autoResizeTextarea(el) {
                if (!el) return;
                el.style.height = 'auto';
                const max = 160;
                el.style.height = Math.min(el.scrollHeight, max) + 'px';
            }
            chatInput.addEventListener('input', () => autoResizeTextarea(chatInput));
            autoResizeTextarea(chatInput);

            // Mobile sidebar toggle
            if (closeSidebarBtn) closeSidebarBtn.addEventListener('click', () => {
                if (sidebar) sidebar.classList.add('hidden');
            });

            function appendMessage(data, sender, originalQuery = "") {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'flex items-start gap-3 message-in';

                if (sender === 'user') {
                    messageWrapper.classList.add('justify-end');
                    messageWrapper.innerHTML = `<div class="bg-blue-600 rounded-xl rounded-br-sm p-4 text-sm max-w-xl shadow-md"><p class="text-white leading-relaxed">${data}</p></div>`;
                } else {
                    const iconHtml = `<div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex-shrink-0 flex items-center justify-center shadow-md text-lg">ü§ñ</div>`;
                    let contentHtml;
                    const hasCodes = Array.isArray(data?.codes) && data.codes.length > 0;
                    
                    if (sender === 'ai-error') {
                        contentHtml = `<div class="bg-red-50 border border-red-200 rounded-xl rounded-tl-sm p-4 text-sm max-w-2xl w-full shadow-sm"><p class="font-semibold text-red-800 mb-2">Error</p><div class="text-red-700">${data.detailed_response}</div></div>`;
                    } else if (data.is_welcome || data.is_conversational) {
                        contentHtml = `<div class="bg-white border border-slate-200 rounded-xl rounded-tl-sm p-4 text-sm max-w-2xl w-full shadow-sm">
                                        <p class="text-slate-700 leading-relaxed">${data.answer || data.detailed_response}</p>
                                    </div>`;
                    } else if (data.needs_tenant_selection) {
                        contentHtml = `<div class="bg-white border border-blue-200 rounded-xl rounded-tl-sm p-4 text-sm max-w-2xl w-full shadow-sm">
                                       <p class="text-blue-800 font-semibold mb-3">Please select a tenant for your query about "${data.original_query}":</p>
                                       <div class="flex flex-wrap gap-2">
                                          ${(data.tenants || []).map(t => `<button class="tenant-selection-btn px-3 py-2 bg-blue-100 text-blue-800 text-xs rounded-lg hover:bg-blue-200 font-medium" data-tenant="${t}" data-query="${data.original_query}">${t}</button>`).join('')}
                                          <button class="skip-tenant-selection-btn px-3 py-2 bg-slate-200 text-slate-700 text-xs rounded-lg hover:bg-slate-300 font-medium" data-query="${data.original_query}">Skip (Auto-Select)</button>
                                       </div>
                                   </div>`;
                    } else {
                        const toHtmlList = (items) => items && items.length > 0 ? `<ul class="list-disc pl-5 mt-2 space-y-1">${items.map(item => `<li>${item}</li>`).join('')}</ul>` : '';
                        
                        const primaryFormLink = (() => {
                            try {
                                for (const s of (data.sources || [])) {
                                    const fname = String(s.filename || '').toLowerCase();
                                    const u = s.url || null;
                                    if (u && (u.endsWith('.pdf') || u.includes('onboard') || u.includes('form'))) {
                                        return { href: u, label: 'Open Form' };
                                    }
                                    if (!u && data.is_download_intent && s.relative_path) {
                                        return { href: `${API_BASE_URL}/download/${data.selected_tenant}/${encodeURIComponent(s.relative_path)}`, label: 'Download Form' };
                                    }
                                }
                            } catch(_) {}
                            return null;
                        })();
                        
                        const onboardingPanel = (data.is_download_intent && primaryFormLink)
                            ? `<div class="p-4 bg-blue-50 border border-blue-200 rounded-lg"><a class="inline-block px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-semibold text-sm shadow-md" href="${primaryFormLink.href}" target="_blank">${primaryFormLink.label}</a><p class="text-xs text-slate-600 mt-2">After accessing the form, review the steps below.</p></div>`
                            : '';
                        
                        const codesHtml = hasCodes ? `<div class="mt-4"><h4 class="text-sm font-semibold text-slate-800 mb-2">Codes</h4><ul class="list-disc pl-5 space-y-1">${data.codes.map(c => `<li class="font-mono text-slate-800 text-sm">${c}</li>`).join('')}</ul></div>` : '';

                        const sourcesHtml = (data.sources && data.sources.length > 0)
                            ? (() => {
                                const uniq = [];
                                const seen = new Set();
                                for (const s of data.sources) {
                                    const key = s.url || s.relative_path || s.filename || '';
                                    const normKey = String(key).toLowerCase();
                                    if (!seen.has(normKey)) {
                                        seen.add(normKey);
                                        uniq.push(s);
                                        if (uniq.length >= 3) break;
                                    }
                                }
                                const scores = uniq.map(s => (typeof s.relevance === 'number' ? s.relevance : 0));
                                const maxScore = Math.max(...scores, 0);
                                return `<div class="mt-4"><h4 class="text-sm font-semibold text-slate-800 mb-2">Sources</h4><ul class="text-xs text-slate-700 space-y-2">${uniq.map((s) => {
                                    const raw = (typeof s.relevance === 'number') ? s.relevance : 0;
                                    const normPct = maxScore > 0 ? Math.round((raw / maxScore) * 100) : 0;
                                    const fname = String(s.filename || '');
                                    const clean = fname.replace(/\.tables\.txt$/,'').replace(/::tables$/,'');
                                    const pathParts = clean.split(/[\\\/]/);
                                    const baseName = pathParts[pathParts.length - 1] || clean;
                                    const parent = pathParts.length > 1 ? pathParts[pathParts.length - 2] : '';
                                    const displayPath = parent ? `${parent}/${baseName}` : baseName;
                                    const pathForUrl = s.relative_path ? s.relative_path : baseName;
                                    const viewPageFrag = (typeof s.page !== 'undefined' && s.page !== null) ? `#page=${encodeURIComponent(s.page)}` : '';
                                    const hasUrl = !!s.url;
                                    const viewHref = hasUrl ? s.url : `${API_BASE_URL}/view/${data.selected_tenant}/${encodeURIComponent(pathForUrl)}${viewPageFrag}`;
                                    const viewLabel = hasUrl ? 'Open URL' : 'Open';
                                    const downloadHref = `${API_BASE_URL}/download/${data.selected_tenant}/${encodeURIComponent(pathForUrl)}`;
                                    const downloadBtn = (!hasUrl && data.is_download_intent) ? `<a class=\"px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 font-medium\" href=\"${downloadHref}\" target=\"_blank\">Download</a>` : '';
                                    return `<li class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-200">
                                               <span class="truncate pr-4 font-medium">${displayPath}</span>
                                               <span class="flex items-center gap-2">
                                                   <span class="font-mono text-blue-600 font-semibold">${normPct}%</span>
                                                    <a class=\"px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 font-medium text-xs\" href=\"${viewHref}\" target=\"_blank\">${viewLabel}</a>
                                                    ${downloadBtn}
                                               </span>
                                           </li>`
                                }).join('')}</ul></div>`;
                              })()
                            : '';

                        const followUpsHtml = (data.follow_up_questions && data.follow_up_questions.length > 0)
                            ? `<div class="mt-4"><h4 class="text-sm font-semibold text-slate-800 mb-2">Follow-up Questions</h4><div class="flex flex-wrap gap-2">${data.follow_up_questions.map(q => `<button class="suggested-question-btn px-3 py-2 bg-blue-50 text-blue-800 text-xs rounded-lg hover:bg-blue-100 border border-blue-200 font-medium">${q}</button>`).join('')}</div></div>`
                            : '';
                        
                        const feedbackHtml = `<div class="feedback-container mt-4 pt-3 border-t border-slate-200 flex items-center gap-3 text-xs text-slate-600">
                                                <span class="font-medium">Was this helpful?</span>
                                                <button class="feedback-btn px-2 py-1 rounded-lg hover:bg-slate-100 border border-slate-200" data-helpful="true">üëç</button>
                                                <button class="feedback-btn px-2 py-1 rounded-lg hover:bg-slate-100 border border-slate-200" data-helpful="false">üëé</button>
                                            </div>`;

                        contentHtml = `<div class="bg-white border border-slate-200 rounded-xl rounded-tl-sm p-4 text-sm max-w-2xl w-full ai-response-content space-y-4 shadow-sm" data-query="${originalQuery}">
                                         ${onboardingPanel}
                                         <div><h4 class="text-sm font-semibold text-slate-800 mb-2">Summary</h4><p class="text-slate-700 leading-relaxed">${data.summary || 'No summary available.'}</p></div>
                                         <div><h4 class="text-sm font-semibold text-slate-800 mb-2">Detailed Response</h4><div class="prose prose-sm text-slate-700">${marked.parse(data.detailed_response || '')}</div></div>
                                         ${(data.key_points && data.key_points.length > 0) ? `<div><h4 class="text-sm font-semibold text-slate-800 mb-2">Key Points</h4>${toHtmlList(data.key_points)}</div>` : ''}
                                         ${(data.suggestions && data.suggestions.length > 0) ? `<div><h4 class="text-sm font-semibold text-slate-800 mb-2">Suggestions</h4>${toHtmlList(data.suggestions)}</div>` : ''}
                                         ${codesHtml}
                                         ${sourcesHtml}
                                         ${followUpsHtml}
                                         ${feedbackHtml}
                                     </div>`;
                    }
                    messageWrapper.innerHTML = `${iconHtml}${contentHtml}`;
                }
                chatWindow.appendChild(messageWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showThinkingIndicator() {
                const indicatorWrapper = document.createElement('div');
                indicatorWrapper.id = 'thinking-indicator';
                indicatorWrapper.className = 'flex items-start gap-3 message-in';
                indicatorWrapper.innerHTML = `<div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex-shrink-0 flex items-center justify-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                        <path d="M12 8V4H8"/>
                        <rect x="4" y="12" width="16" height="8" rx="2"/>
                        <path d="M4 14h16"/>
                    </svg>
                </div><div class="bg-white border border-slate-200 rounded-xl rounded-tl-sm p-4 text-sm text-slate-700 shadow-sm"><div class="typing-indicator flex items-center gap-2"><span class="w-2 h-2 bg-blue-600 rounded-full"></span><span class="w-2 h-2 bg-blue-600 rounded-full"></span><span class="w-2 h-2 bg-blue-600 rounded-full"></span><span class="ml-2 font-medium">Thinking...</span></div></div>`;
                chatWindow.appendChild(indicatorWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function removeThinkingIndicator() {
                const indicator = document.getElementById('thinking-indicator');
                if (indicator) indicator.remove();
            }

            // --- Signout ---
            document.getElementById('signout-btn').addEventListener('click', async () => {
                try {
                    await fetch(`${API_BASE_URL}/auth/signout`, { method: 'POST', credentials: 'include' });
                } finally { window.location.href = '/auth.html'; }
            });

            // --- Event Delegation ---
            chatWindow.addEventListener('click', async (e) => {
                const feedbackBtn = e.target.closest('.feedback-btn');
                const suggestedBtn = e.target.closest('.suggested-question-btn');
                const tenantBtn = e.target.closest('.tenant-selection-btn');
                const skipBtn = e.target.closest('.skip-tenant-selection-btn');

                if (suggestedBtn) submitQuery(suggestedBtn.textContent);
                if (tenantBtn) {
                    const originalQuery = tenantBtn.dataset.query;
                    const tenant = tenantBtn.dataset.tenant;
                    const newQuery = `${originalQuery} for ${tenant}`;
                    submitQuery(newQuery);
                }
                if (skipBtn) {
                    const originalQuery = skipBtn.dataset.query;
                    const newQuery = `${originalQuery} [AUTO]`;
                    submitQuery(newQuery);
                }

                if (feedbackBtn) {
                    const isHelpful = feedbackBtn.dataset.helpful === 'true';
                    const responseContainer = feedbackBtn.closest('.ai-response-content');
                    const query = responseContainer.dataset.query;
                    const feedbackContainer = feedbackBtn.parentElement;
                    
                    feedbackContainer.innerHTML = `<span class="text-xs text-slate-600 font-medium">Thank you for your feedback!</span>`;

                    try {
                        const res = await fetch(`${API_BASE_URL}/feedback`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query, is_helpful: isHelpful })
                        });
                        if (!res.ok) throw new Error('Feedback request failed');
                        
                        if (!isHelpful) {
                            const data = await res.json();
                            const suggestions = Array.isArray(data.suggestions) ? data.suggestions.slice(0, 3) : [];
                            if (suggestions.length > 0) {
                                const rephraseContainer = document.createElement('div');
                                rephraseContainer.className = 'mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                                rephraseContainer.innerHTML = `<h5 class="text-xs font-semibold text-blue-800 mb-2">Try rephrasing your question:</h5><div class="flex flex-wrap gap-2">${suggestions.map(q => `<button class="suggested-question-btn px-3 py-2 bg-blue-100 text-blue-800 text-xs rounded-lg hover:bg-blue-200 font-medium">${q}</button>`).join('')}</div>`;
                                responseContainer.appendChild(rephraseContainer);
                            }
                        }
                    } catch (error) {
                        showNotification(error.message, true);
                    }
                }
            });
            
            // --- Chat History ---
            async function loadChatHistory() {
                const me = await ensureAuth(); if (!me) return;
                const start = startDateFilter.value;
                const end = endDateFilter.value;
                let url = `${API_BASE_URL}/history`;
                if (start && end) url += `?start=${start}&end=${end}`;

                try {
                    const res = await fetch(url, { credentials: 'include' });
                    if (!res.ok) throw new Error("Could not fetch history");
                    const history = await res.json();
                    
                    chatHistoryList.innerHTML = '';
                    if (history.length === 0) {
                        chatHistoryList.innerHTML = '<p class="text-xs text-slate-500 p-3 bg-slate-50 rounded-lg border border-slate-200">No history found for this period.</p>';
                        return;
                    }

                    history.reverse().forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'p-3 text-sm text-slate-700 rounded-lg cursor-pointer hover:bg-slate-50 border border-slate-200 hover:border-blue-300 transition-all';
                        const date = new Date(item.timestamp).toLocaleString();
                        li.innerHTML = `<span class="block font-semibold text-slate-900 truncate">${item.query.substring(0, 40)}...</span><span class="text-xs text-slate-500 mt-1 block">${date}</span>`;
                        li.title = item.query;
                        li.onclick = () => { 
                            chatWindow.innerHTML = ''; 
                            appendMessage(item.query, 'user'); 
                            appendMessage(item.response, 'ai', item.query); 
                        };
                        chatHistoryList.appendChild(li);
                    });
                } catch (err) { 
                    chatHistoryList.innerHTML = '<p class="text-xs text-red-600 p-3 bg-red-50 rounded-lg border border-red-200">Could not load history.</p>';
                    showNotification(err.message, true);
                }
            }
            
            startDateFilter.addEventListener('change', loadChatHistory);
            endDateFilter.addEventListener('change', loadChatHistory);
            newConversationBtn.addEventListener('click', ()=>{
                displayWelcomeMessage();
                loadChatHistory();
            });

            // --- Upload Functions ---
            async function fetchTenants() {
                try {
                    const res = await fetch(`${API_BASE_URL}/tenants`);
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Failed to fetch tenants');
                    if (tenantSelect) {
                        tenantSelect.innerHTML = '<option value="">-- Select --</option>';
                        data.tenants.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t;
                            opt.textContent = t;
                            tenantSelect.appendChild(opt);
                        });
                    }
                    const schSelect = document.getElementById('sch-tenant-select');
                    if (schSelect) {
                        schSelect.innerHTML = '<option value="">-- Select --</option>';
                        (data.tenants || []).forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t;
                            opt.textContent = t;
                            schSelect.appendChild(opt);
                        });
                    }
                } catch (error) {
                    showNotification(error.message, true);
                }
            }

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); fileInput.files = e.dataTransfer.files; updateFileList(); });
            fileInput.addEventListener('change', updateFileList);
            
            function updateFileList() {
                fileList.innerHTML = '';
                if (fileInput.files.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'list-disc pl-5 text-slate-700 space-y-1';
                    for (const file of fileInput.files) {
                        const li = document.createElement('li');
                        li.textContent = `${file.name}`;
                        list.appendChild(li);
                    }
                    fileList.appendChild(list);
                }
            }
            
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = uploadForm.querySelector('button[type="submit"]');
                const formData = new FormData(uploadForm);

                if (!formData.get('tenant_id') && !formData.get('new_tenant_id')) {
                    showNotification('Please select or create a tenant.', true);
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = 'Ingesting...';
                uploadSummary.classList.add('hidden');

                try {
                    const res = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await res.json();
                    if(!res.ok && res.status !== 207) throw new Error(result.error || (result.errors && result.errors.join(', ')) || 'Server error');
                    
                    showNotification(result.message || 'Ingestion complete!');
                    let summaryHtml = `<strong class="text-slate-900">Status:</strong> <span class="text-slate-700">${result.message}</span><br>`;
                    if(result.details && result.details.length) summaryHtml += `<strong class="text-slate-900">Details:</strong><ul class="mt-2 space-y-1">${result.details.map(d => `<li class="text-slate-700">${d}</li>`).join('')}</ul>`;
                    if(result.errors && result.errors.length) summaryHtml += `<strong class="text-red-600">Errors:</strong><ul class="mt-2 space-y-1">${result.errors.map(e => `<li class="text-red-700">${e}</li>`).join('')}</ul>`;
                    uploadSummary.innerHTML = summaryHtml;
                    uploadSummary.classList.remove('hidden');

                    uploadForm.reset();
                    fileList.innerHTML = '';
                    fetchTenants();
                } catch (error) {
                    showNotification(error.message, true);
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Upload & Ingest';
                }
            });
            
            // --- Scheduler Functions ---
            async function loadSchedules() {
                try {
                    const res = await fetch(`${API_BASE_URL}/schedules`, { credentials: 'include' });
                    const data = await res.json();
                    const list = document.getElementById('schedules-list');
                    const empty = document.getElementById('schedules-empty');
                    if (!res.ok) throw new Error(data.error || 'Failed to fetch schedules');
                    const items = data.schedules || [];
                    if (items.length === 0) {
                        list.innerHTML = '';
                        if (empty) empty.classList.remove('hidden');
                        return;
                    }
                    if (empty) empty.classList.add('hidden');
                    list.innerHTML = items.map(s => `
                        <li class="flex items-center justify-between bg-slate-50 border border-slate-200 rounded-lg p-3">
                            <span class="truncate mr-3 text-slate-700"><strong class="text-slate-900">${s.tenant}</strong> ‚Äî ${s.url} ‚Äî ${s.frequency} ‚Äî ${s.start_time || ''}</span>
                            <span class="flex items-center gap-2 flex-shrink-0">
                                <button class="px-3 py-1.5 text-xs border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-100 sched-edit-btn font-medium" data-id="${s.id}">Edit</button>
                                <button class="px-3 py-1.5 text-xs border border-red-300 rounded-lg text-red-700 hover:bg-red-50 sched-del-btn font-medium" data-id="${s.id}">Delete</button>
                            </span>
                        </li>`).join('');
                } catch (e) { showNotification(e.message, true); }
            }
            
            const scheduleForm = document.getElementById('schedule-form');
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const sel = document.getElementById('sch-tenant-select');
                    const neu = document.getElementById('sch-tenant-new');
                    const tenant = (neu && neu.value.trim()) || (sel && sel.value.trim()) || '';
                    const payload = {
                        tenant,
                        url: document.getElementById('sch-url').value.trim(),
                        frequency: document.getElementById('sch-frequency').value,
                        start_time: document.getElementById('sch-start').value
                    };
                    if (!payload.tenant) { showNotification('Please select or enter a tenant.', true); return; }
                    try {
                        const res = await fetch(`${API_BASE_URL}/schedules`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Failed to add schedule');
                        showNotification('Schedule added');
                        scheduleForm.reset();
                        loadSchedules();
                    } catch (err) { showNotification(err.message, true); }
                });
            }

            // Schedules list actions
            document.getElementById('scheduler-panel').addEventListener('click', async (e) => {
                const delBtn = e.target.closest('.sched-del-btn');
                const editBtn = e.target.closest('.sched-edit-btn');
                if (delBtn) {
                    const id = delBtn.dataset.id;
                    try {
                        const res = await fetch(`${API_BASE_URL}/schedules/${id}`, { method: 'DELETE', credentials: 'include' });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Failed to delete');
                        showNotification('Schedule deleted');
                        loadSchedules();
                    } catch (err) { showNotification(err.message, true); }
                }
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    try {
                        const res0 = await fetch(`${API_BASE_URL}/schedules`, { credentials: 'include' });
                        const data0 = await res0.json();
                        const curr = (data0.schedules || []).find(x => String(x.id) === String(id));
                        if (!curr) { showNotification('Schedule not found', true); return; }
                        const tenant = prompt('Tenant', curr.tenant || '');
                        if (tenant === null) return;
                        const url = prompt('URL', curr.url || '');
                        if (url === null) return;
                        const frequency = prompt('Frequency (hourly,daily,weekly,monthly,3months,6months)', curr.frequency || '');
                        if (frequency === null) return;
                        const start_time = prompt('Start time (ISO/datetime-local)', curr.start_time || '');
                        if (start_time === null) return;
                        const res = await fetch(`${API_BASE_URL}/schedules/${id}`, {
                            method: 'PUT', headers: { 'Content-Type': 'application/json' }, credentials: 'include',
                            body: JSON.stringify({ tenant, url, frequency, start_time })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Failed to update');
                        showNotification('Schedule updated');
                        loadSchedules();
                    } catch (err) { showNotification(err.message, true); }
                }
            });
            
            // --- Analytics Functions ---
            async function loadAnalytics() {
                try {
                    const res = await fetch(`${API_BASE_URL}/analytics`, { credentials: 'include' });
                    const data = await res.json();
                    if (!res.ok) {
                        if (res.status === 401) throw new Error('Please sign in to view analytics.');
                        throw new Error("Could not fetch analytics");
                    }

                    const labels = Array.isArray(data.labels) ? data.labels : [];
                    const values = Array.isArray(data.data) ? data.data : [];
                    const canvas = document.getElementById('tenant-chart');
                    if (!canvas) throw new Error('Analytics canvas not found');
                    const ctx = canvas.getContext('2d');
                    if(tenantChart) tenantChart.destroy();
                    
                    const colors = ['#2563eb', '#0891b2', '#6366f1', '#0ea5e9', '#3b82f6', '#06b6d4', '#1d4ed8', '#7c3aed', '#0284c7', '#60a5fa'];
                    
                    tenantChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels,
                            datasets: [{
                                data: values,
                                backgroundColor: colors,
                                borderColor: '#ffffff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#475569',
                                        font: {
                                            size: 12,
                                            family: 'Inter'
                                        },
                                        padding: 15
                                    }
                                }
                            }
                        }
                    });

                    const list = document.getElementById('tenant-list');
                    if (list) list.innerHTML = labels.map((l, idx) => `<li class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200"><span class="inline-block w-4 h-4 rounded flex-shrink-0" style="background:${colors[idx % colors.length]}"></span><span class="flex-1 text-slate-900 font-medium">${l}:</span><strong class="text-slate-900">${values[idx] ?? 0} queries</strong></li>`).join('');
                } catch(err) {
                    showNotification(err.message, true);
                    const list = document.getElementById('tenant-list');
                    if (list) list.innerHTML = '<li class="text-red-600 p-3 bg-red-50 rounded-lg border border-red-200">Could not load analytics.</li>';
                }
            }
            
            // --- Initial State ---
            displayWelcomeMessage();
            fetchTenants();
            loadChatHistory();
        });
    </script>
</body>
</html>
